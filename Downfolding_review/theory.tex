\newtheorem{theorem}{Theorem}
\newtheorem{definition}{Definition}


\section{Downfolding as a compression of the energy functional}

\subsection{Theory} 

Suppose we start with a quantum system with Hamiltonian $H$ and Hilbert space ${\mathcal H}$.

\begin{definition}
Let the energy functional be $E[\Psi] = \frac{\bra{\Psi}H\ket{\Psi}}{\braket{\Psi|\Psi}}$ for a wavefunction $\ket{\Psi} \in {\mathcal H}$.
\end{definition}


\begin{definition}
Let ${\mathcal LE}(H,N)$ be a subset of ${\mathcal H}$ spanned by $N$ vectors given by the lowest energy solutions to $H\ket{\Phi_i}=E_i{\Phi_i}$. 
\end{definition}

\begin{definition}
$H_{eff}$ is an operator on the Hilbert space ${\mathcal LE(H,N)}$.	 
\end{definition}


\begin{definition}
The effective model $E_{eff}[\Psi]=\frac{\bra{\Psi}H_{eff}\ket{\Psi}}{\braket{\Psi|\Psi}}$ is a functional from ${\mathcal LE} \rightarrow \mathbb{R}$
\end{definition}



\begin{theorem}
\label{theorem:criticalpoint}
$E[\Psi]$ has a critical point only where $\Psi$ is an eigenstate of $H$.
\end{theorem}
\begin{proof}
\lucas{This is not a new result, but I can't find a good proof of this. } 
This can be proved by using a spectral expansion. 
Write $\ket{\Psi} = \sum_i c_i \ket{\Phi_i}$, where $H\ket{\Phi_i}=E_i\ket{\Phi_i}$. 
Then 
\begin{equation}
E[\Psi] = \frac{\sum_i c_i^2 E_i}{\sum_i c_i^2}.
\end{equation}
Taking the derivative, 
\begin{align}
\frac{\partial E[\Psi]}{\partial c_j } &= \frac{2 c_j E_j}{\sum_i c_i^2} - \frac{2c_j \sum_i c_i^2 E_i}{(\sum_i c_i^2)^2} \\
&= 2c_j \left(\frac{E_j}{\sum_i c_i^2} - \frac{\sum_i c_i^2 E_i}{(\sum_i c_i^2)^2}\right) 
\end{align}
Since $\frac{\partial E[a\Psi]}{\partial c_j } = \frac{\partial E[\Psi]}{\partial c_j }$ for any constant $a$, let's consider only normalized wave functions.
Then the equation for the critical points is 
\begin{equation}
c_j\left(E_j - \sum_i c_i^2 E_i\right) = c_j (E_j - E[\Psi]) = 0	
\label{eqn:denergyfunctional}
\end{equation}


First, let's show that all eigenstates are critical points. 
Suppose $\Psi$ is an eigenfunction. 
Then either $c_j=0$ or $E_j = E[\Psi]$, so Eqn~\ref{eqn:denergyfunctional} is satisfied.  


Now, let's show that all critical points are eigenstates. 
We will do this using the contrapositive.
Suppose that $\ket{\Psi}$ is not an eigenstate. 
Then there are at least two coefficients, $j_1$ and $j_2$ such that $E_{j_1} \neq E_{j_2}$, $c_{j_1}\neq 0$, and $c_{j_2}\neq 0$.\footnote{If  $E_{j_1} = E_{j_2}$ for all non-zero coefficients, then $\ket{\Psi}$ is an eigenstate.}
Thus in order for Eqn~\ref{eqn:denergyfunctional} to be satisfied for all $j$, we must have 
\begin{equation}
E_{j_1} = E[\Psi] \text{ and } E_{j_2} = E[\Psi].
\end{equation}
This is not possible because $E_{j_1} \neq E_{j_2}$. 
Therefore, all eigenstates are critical points and all non-eigenstates are not critical points.
\end{proof}


\begin{theorem} 	
If $E_{eff}[\Psi] = E[\Psi], \forall \ket{\Psi} \in {\mathcal LE}$, then $H_{eff} \ket{\Phi_i} = E_i\ket{\Phi_i}$ for all eigenstates $\ket{\Phi_i}\in {\mathcal LE}$.
\end{theorem}
\begin{proof}
	Suppose that $\ket{\Phi_i}$ is an eigenstate of $H$. Then 
	\begin{equation}
	\left.\frac{\partial E[\Psi]}{\partial\Psi}\right|_{\Psi=\Phi_i} = 0 
	\end{equation}
If this is true, then certainly the derivative on the low-energy manifold is also zero.
Since $E_{eff}[\Psi] = E[\Psi]$, 
\begin{equation}
	\left.\frac{\partial E_{eff}[\Psi]}{\partial\Psi}\right|_{\Psi=\Phi_i} = 0 
\end{equation}
for $\ket{\Psi} \in {\mathcal LE}$. Using Theorem~\ref{theorem:criticalpoint}, $H_{eff} \ket{\Phi_i} = E_i\ket{\Phi_i}$. 
Similarly, if the derivative is not zero, then the wave function must not be an eigenstate.
\end{proof}

We have thus reduced the problem of finding an effective Hamiltonian $H_{eff}$ that reproduces the low-energy spectrum of $H$ to matching the corresponding energy functionals $E[\Psi]$ and $E_{eff}[\Psi]$. 
An important result of this is that it is not necessary to diagonalize either of the Hamiltonians; one must only be able to select wave functions from the low-energy space ${\mathcal LE}$.
As we shall see, this can be substantially easier than attaining full eigenstates.


The theory presented above maps coarse-graining into a functional approximation problem. 
This is still rather intimidating, since even supposing one can generate wave functions in the low-energy space, they are still complicated objects in a very large space.
An effective way to accomplish this is through the use of descriptors, $d_i[\Psi]$, which map from ${\mathcal H} \rightarrow \mathbb{R}$.
Then we can approximate the energy functional as follows
\begin{equation}
E_{eff}[\Psi] \simeq \sum_i f_i(d_i[\Psi]),
\end{equation}
where $f_i$ are some parameterized functions.
This will allow us to use techniques from statistical learning to efficiently describe $E_{eff}$.

\subsection{Practical protocol}

\tikzstyle{decision} = [diamond, draw, fill=blue!10, 
    text width=4.5em, text badly centered, node distance=3cm, inner sep=0pt]
\tikzstyle{block} = [rectangle, draw, fill=blue!10, 
    text width=5em, text centered, rounded corners, minimum height=4em]
\tikzstyle{result} = [rectangle, draw, fill=red!10, 
    text width=5em, text centered, rounded corners, minimum height=4em]
\tikzstyle{line} = [draw,-latex',very thick]
\tikzstyle{cloud} = [draw, ellipse,fill=red!20, node distance=3cm,
    minimum height=2em]
\begin{figure*}
\begin{tikzpicture}[scale=2,node distance = 3cm, auto]
    % Place nodes
    \node [block] (wfs) {Generate $\ket{\Psi_i} \in {\mathcal LE}$};
    \node [block, right of=wfs] (descriptors) {Generate $d_j[\Psi_i]$,$E[\Psi_i]$};
    \node [block, right of=descriptors] (assess) {Assess descriptors};
    \node [block, right of=assess] (ansatz) {Ansatz: $E_i \simeq \sum_j p_j d_{ij}$};
    \node [block, right of=ansatz] (fit) {Fit bounding plane};
    \node [result, right of=fit] (model) {Effective model};
    % Draw edges
    \path [line] (wfs) -- (descriptors);
    \path [line] (descriptors) -- (assess);
    \path [line] (assess) --  (ansatz);
    \path [line] (ansatz) --  (fit);
    \path [line] (fit) --  (model);

    \path [line] (assess.south) -- ($ (assess.south) + (0,-0.2)$) 
                 -- node [below] {Incomplete sampling} 
                 ($ (wfs.south) + (0,-0.2)$) --  (wfs.south);
    \path [line] (assess.north) -- ($ (assess.north) + (0,0.2)$) 
                 -- node [above] {Incomplete descriptor space} 
                 ($ (descriptors.north) + (0,0.2)$) --  (descriptors.north);

\end{tikzpicture}
\caption{A practical protocol for fitting effective models to {\it ab initio} data.}
\label{fig:protocol} 
\end{figure*}

A practical protocol is presented in Fig~\ref{fig:protocol}. 
Let's go through this step by step.

\paragraph{Generating $\ket{\Psi_i}\in {\mathcal LE}$}. 
Ideally one would be able to sample the entire low-energy space. 
Typically, however, the space will be too large and it will need to be sampled. 
The optimal wave functions to use depend on the models one expects to fit, which we will discuss in detail  in later steps. 
Simple strategies that we will use in the examples below include excitations with respect to a determinant and varying spin states.


\paragraph{Generate $d_j[\Psi_i]$ and $E[\Psi_i]$}. 
The choice of descriptor is fundamental to the success of the downfolding. 
In the case of a second-quantized Hamiltonian
\begin{equation}
\hat{H}_{eff} = E_0 + \sum_{ij} t_{ij} (c_i^\dagger c_j + h.c.) + \sum_{ijkl} V_{ijkl} c_i^\dagger c_j^\dagger c_k c_l,
\end{equation}
a set of linear descriptors by simply taking the expectation value of both sides of the equation. 
Then for example, the occupation descriptor for orbital $k$ is $d_{occ(k)}[\Psi_i] = \braket{\Psi_i | c_k^\dagger c_k | \Psi}$; the double occupation descriptor for orbital $k$ is $d_{double(k)}[\Psi_i] = \braket{\Psi_i | n_{k\uparrow}n_{k\downarrow} | \Psi}$. 
The orbital that $c_k$ represents is part of the descriptor, and in the examples below we will discuss this choice as well.
One is not limited to static orbital descriptors; they may have a more complex functional dependence on the trial function to include orbital relaxation.

 
\paragraph{Assess descriptors}
At this point, one has collected the data $E_i$ and $d_{ij}$. 
If two descriptors have a large correlation coefficient, then they are redundant in the data set. 
This could either mean that the sampling of the low-energy Hilbert space ${\mathcal LE}$ was insufficient, or that they are both proxies for the same differences in states. 
If two data points have the same or very similar descriptor sets, but different energies, then either the descriptor set is not enough to describe the variations in the low-energy space, or the sampling has generated states that are not in the low-energy space.
To resolve these possibilities, one should analyze the difference between the two wave functions.  
\lucas{Choosing the reduced set is not so easy. If you choose wrong then you can get intruder states once you solve the effective model. Super subtle point which is not so easy to get across. That is, which descriptors we use interacts with the model Hilbert space. We want the edges of our Hilbert space to be represented in or at least near our sampled wave functions. This is why it's good to have eigenstates in your set if possible; they are guaranteed to be on the corners of your descriptor space if everything is working correctly.}


\paragraph{Ansatz: $E_i \simeq \sum_i  d_{ij} p_j$} 
If the descriptors are chosen well, then the model can be written in linear form:
\begin{equation}
E[\Psi_i] = \sum_j p_j d_j[\Psi_i],	
\end{equation}
which we shorten to 
\begin{equation}
{\bf E} = D{\bf p} .
\end{equation}
If this can be done, the fitting problem is reduced to a linear regression optimization.
More complex functions of the descriptors are also possible, although at the cost of making the effective model more difficult to solve and complicating the fitting procedure.


\paragraph{Fit bounding plane}
\begin{itemize}
\item Removing redundant descriptors: LASSO, or matching pursuit
\item The space of descriptors is smaller than the space of wave functions, so some wave functions will map to the same point in descriptor space. In that case, the low-energy space is given by the bounding plane.
\end{itemize}

